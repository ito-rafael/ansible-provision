# the "Arch-packaged" way
# name: development | latex | install & config (La)TeX environment
#  tags: dev,latex
#  package:
#    name:
#      - texlive-base
#      - texlive-bin
#      - texlive-latexextra
#      - texlive-fontsextra
#      - texlive-publishers
#      - texlive-bibtexextra
#      - texlive-science
#      - texlive-plaingeneric

# native TeX Live

- name: development | latex | check if TeX Live of current year is already installed
  tags: dev,latex
  ansible.builtin.stat:
    path: /usr/local/texlive/{{ ansible_date_time.year }}/bin/x86_64-linux/pdftex
  register: texlive_pdftex

- name: development | latex | ensure LaTeX installer dir exists
  tags: dev,latex
  become_user: rafael
  ansible.builtin.file:
    path: /home/rafael/.cache/install-tl
    state: directory
    owner: rafael
    group: rafael
    mode: 0700
  when: not texlive_pdftex.stat.exists

- name: development | latex | download latest TeX Live installer
  tags: dev,latex
  become_user: rafael
  ansible.builtin.get_url:
    url: https://mirror.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
    dest: /home/rafael/.cache/install-tl
  when: not texlive_pdftex.stat.exists

- name: development | latex | unpack latest TeX Live installer
  tags: dev,latex
  become_user: rafael
  ansible.builtin.unarchive:
    remote_src: yes
    src: /home/rafael/.cache/install-tl/install-tl-unx.tar.gz
    dest: /home/rafael/.cache/install-tl
  when: not texlive_pdftex.stat.exists

- name: development | latex | check if LaTeX installer is for current year
  tags: dev,latex
  become_user: rafael
  ansible.builtin.find:
    paths: /home/rafael/.cache/install-tl/
    patterns: "install-tl-{{ ansible_date_time.year }}*"
    file_type: directory
  register: texlive_current_year_dir

- name: development | latex | rename LaTeX installer dir with current year
  tags: dev,latex
  become_user: rafael
  ansible.builtin.command:
    cmd: mv "{{ texlive_current_year_dir.files[0].path }}" "/home/rafael/.cache/install-tl/{{ ansible_date_time.year }}"
  when: texlive_current_year_dir.matched == 1

- name: development | latex | delete tar.gz installer file
  tags: dev,latex
  become_user: rafael
  ansible.builtin.file:
    path: /home/rafael/.cache/install-tl/install-tl-unx.tar.gz
    state: absent
  when: texlive_current_year_dir.matched == 1

- name: development | latex | install TeX Live
  tags: dev,latex
  #become_user: rafael
  ansible.builtin.shell:
  args:
    cmd: perl ./install-tl --no-interaction
    chdir: /home/rafael/.cache/install-tl/{{ ansible_date_time.year }}
  when: texlive_current_year_dir.matched == 1

- name: development | latex | put executables dir in PATH
  tags: dev,latex
  lineinfile:
    path: /home/rafael/.config/zsh/.zshenv
    line: 'export PATH=$PATH:/usr/local/texlive/{{ ansible_date_time.year }}/bin/x86_64-linux  # TeX Live'
    state: present
    regexp: 'export PATH=\$PATH:/usr/local/texlive/\d{4}/bin/x86_64-linux .*# TeX Live'

- name: development | latex | install Zotero
  tags: dev,latex,zotero
  become_user: aurman
  kewlfft.aur.aur:
    name: zotero-bin
