- name: system | mamba | download Miniforge installer
  tags: system,mamba
  ansible.builtin.get_url:
    url: "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh"
    dest: "/tmp/Miniforge3.sh"
    mode: '0755'

# flags:
#   -b: batch mode (run silently)
#   -u: update
#   -p: prefix/path (set to /opt/mamba)
- name: system | mamba | run Miniforge installer
  tags: system,mamba
  ansible.builtin.command: "/tmp/Miniforge3.sh -b -u -p /opt/mamba"
  args:
    creates: /opt/mamba

- name: system | mamba | make mamba available to users upon login
  tags: system,mamba
  ansible.builtin.copy:
    dest: /etc/profile.d/mamba.sh
    content: |
      export MAMBA_ROOT_PREFIX=/opt/mamba
      . /opt/mamba/etc/profile.d/conda.sh
      . /opt/mamba/etc/profile.d/mamba.sh
    owner: root
    group: root
    mode: '0644'

- name: system | mamba | config global condarc for user envs
  tags: system,mamba
  ansible.builtin.copy:
    dest: /opt/mamba/.condarc
    content: |
      # Set default channels
      channels:
        - conda-forge

      # route new envs and cached packages to the user's home dir
      envs_dirs:
        - ~/.conda/envs
        - /opt/mamba/envs
      pkgs_dirs:
        - ~/.conda/pkgs
        - /opt/mamba/pkgs
    owner: root
    group: root
    mode: '0644'
